---
title: "Sonoma State University - ICLM Analysis (Data from 6 Regular Terms)"
author: "Rich McGowan"
date: "November 25, 2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```
###  Initiate the Workspace and Import the 2 Data Sets from CSV Files
###  Produced by CS Queries
```{r Initiate and Import Data, echo=FALSE}
setwd("C:/Users/Richard/OneDrive/Rich Files/SSU/2018/SonomaStateICLM/project")
library(readr)
library(tidyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(knitr)
library(kableExtra)
library(data.table)
library(tinytex)
#Read in the CSV data produced from Campus SOlutions Query and saved in local folder
ICLM_MAIN <- read_csv("ICLM_MAIN.csv",col_names = TRUE)
```
###  Munge the data sets
```{r Munge, echo=TRUE}
ICLM_MAIN$AdmitType <- factor(ICLM_MAIN$AdmitType)
UGRD_MAIN <- data.table(ICLM_MAIN %>% filter(Career == 'UGRD',UnitsTakenPrgrss > 0))
PBAC_MAIN <- data.table(ICLM_MAIN %>% filter(Career == 'PBAC',UnitsTakenPrgrss > 0))
#Calculate Undergraduate FTES taking the Average based on the distinct number of terms in the dataframe (e.g. summing the Units Taken Profgressby dividing by 6 regular terms gives a 3 year average)
numterms <- as.integer(count(distinct(UGRD_MAIN,Term)))
UGRD_FTE_THREEYRAVG <- UGRD_MAIN %>% group_by(StdntCollege,Major,CrseCollege) %>% summarize(FTES= round(sum(UnitsTakenPrgrss)/15)/numterms)

#Group the UGRD_MAIN data frame so that average headcount can be calculated
headcountdf <- distinct(UGRD_MAIN,ID,StdntCollege,Major,Term) %>% group_by(StdntCollege,Major) %>% count(ID)
headcountdf <- headcountdf %>% mutate(hcavg = n/numterms) %>% select(StdntCollege,Major,hcavg)
headcountdf <- headcountdf %>% group_by(StdntCollege,Major) %>% summarize(sum(hcavg))
names(headcountdf)[3] <- "HeadCount"
```

###  Pivot Table of FTES UGRD College/Major by Course/College
```{r Create Pivot, echo=TRUE}
# Transform the Row Values of Course College into Column Values for the Data Frame (using the dcast function)
Major_Course_College_Pivot <- dcast(UGRD_FTE_THREEYRAVG, StdntCollege+Major~CrseCollege)
Major_Course_College_Pivot$`Extended Education` <- NULL

# Replace the NA FTES values with zeros
Major_Course_College_Pivot$`Arts and Humanities`[which(is.na(Major_Course_College_Pivot$`Arts and Humanities`))] <- 0
Major_Course_College_Pivot$`Business and Economics`[which(is.na(Major_Course_College_Pivot$`Business and Economics`))] <- 0
Major_Course_College_Pivot$Education[which(is.na(Major_Course_College_Pivot$Education))] <- 0
Major_Course_College_Pivot$`Science & Technology`[which(is.na(Major_Course_College_Pivot$`Science & Technology`))] <- 0
Major_Course_College_Pivot$`Social Sciences`[which(is.na(Major_Course_College_Pivot$`Social Sciences`))] <- 0
Major_Course_College_Pivot$`University-wide`[which(is.na(Major_Course_College_Pivot$`University-wide`))] <- 0
```
### Add HeadCount to the Major_Course_College data frame
```{r Add HeadCount, ECHO=TRUE}
Major_Course_College_Pivot <- bind_cols(headcountdf,Major_Course_College_Pivot) 
#Drop the superfluous Columns from the data frame
Major_Course_College_Pivot$StdntCollege1 <- NULL
Major_Course_College_Pivot$Major1 <- NULL

```


### Write the Resulting Data Frame Out to a CSV file
```{r Output Dataframe, ECHO=TRUE}
setwd("C:/Users/Richard/OneDrive/Rich Files/SSU/2018/SonomaStateICLM/project")
write.csv(Major_Course_College_Pivot,file = "Major_Course_College_Pivot.csv")
```



#Sum the Numeric Columns
#myNumCols <- which(unlist(lapply(UGRD_FTE_THREEYRAVG,is.numeric)))
#UGRD_FTE_THREEYRAVG[(nrow(UGRD_FTE_THREEYRAVG) + 1), myNumCols] <- colSums(round(UGRD_FTE_THREEYRAVG[, myNumCols]), na.rm=TRUE)
#Add the TOTAL row label to the last row
#UGRD_FTE_THREEYRAVG[(nrow(UGRD_FTE_THREEYRAVG)), ncol(UGRD_FTE_THREEYRAVG)-4] #<- 'TOTAL'

#Subtotal FTES by College
Subtotals_by_College <- aggregate(cbind(Major_Course_College_Pivot$`Arts and Humanities`,Major_Course_College_Pivot$`Business and Economics`,Major_Course_College_Pivot$Education,Major_Course_College_Pivot$`Science & Technology`,Major_Course_College_Pivot$`Social Sciences`,Major_Course_College_Pivot$`University-wide`),by=list(StdntCollege=Major_Course_College_Pivot$StdntCollege), FUN=sum)
```
#Rename the Column and Row Names Appropriately
```{r Cleanup Column and Row Names, echo=TRUE}
for (i in 2:7) {
names(Subtotals_by_College)[i] <- names(Major_Course_College_Pivot)[i+1]
}

#Add "TOTAL" to the row label for sub totals
for (i in 1:7) {
    Subtotals_by_College$StdntCollege[i] <-      paste(Subtotals_by_College$StdntCollege[i]," TOTAL")
}
Subtotals_by_College[,"Major"] <- " "
Subtotals_by_College <- Subtotals_by_College %>% select(StdntCollege,Major,names(Subtotals_by_College)[2:7])

```

###  Add the Student College FTES Subtotals to the Data Frame
```{r Add Subtotals, echo=TRUE}
#Find the Row Index of When the StdntCollege Changes
indexes <- which(Major_Course_College_Pivot$StdntCollege != lag(Major_Course_College_Pivot$StdntCollege))
#Loop and Re_Build the Major Course College Pivot with Subtotals
counter <- 1
Major_Course_College_Pivot_New <- data.frame(Major_Course_College_Pivot)
Major_Course_College_Pivot_New[,1:8] <- ""

for (j in 1:length(indexes)) {
  
  for (k in counter:indexes[j]) {
    df <- Major_Course_College_Pivot[counter:indexes[k]-1,]
    df2 <- Subtotals_by_College[j,]
    test_df <- rbind(df,df2)
    counter <- k
  }
  
  Major_Course_College_Pivot_New <- rbind(test_df,Major_Course_College_Pivot_New)
}


```

###  Output of FTES UGRD Statistics (Average of 3 Years)
```{r Outuput1, echo=TRUE}
kable(Major_Course_College_Pivot) %>% 
kable_styling("striped", full_width = F, position = "center", font_size = 10)

```
###  Output of Undergraduate College Pivot
```{r Outuput2, echo=TRUE}
kable(College_Pivot) %>% 
kable_styling("striped", full_width = F, position = "center", font_size = 10)
```
###  Plot 1 Bar Chart
```{r}
UGRD_FTE_THREEYRAVG %>% ggplot(aes(x=AdmitType,y=TotalUnits,fill=StdntCollege))+
  geom_bar(stat="identity", width=0.5)+
  theme_minimal()
```
### Plot 2 - Bar Chart
```{r}
College_Pivot %>% ggplot(aes(x=StdntCollege,y=TotUnits,fill=CrseCollege)) +
  geom_bar(stat="identity", width=0.75) + coord_flip() +
  theme(legend.title = element_text(colour="blue", size=8, face="bold"))+
  theme(legend.text = element_text(colour="blue", size = 8, face = "bold"))+
  ylab("Total Units")+xlab("Students' Major College")
```

